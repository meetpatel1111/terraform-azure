name: Terraform Azure CI/CD

on:
  pull_request:
    paths:
      - '**/*.tf'
      - 'environments/**/*.tfvars'
      - '.github/workflows/terraform-ci-cd.yml'
  push:
    branches: [ main ]
    paths:
      - '**/*.tf'
      - 'environments/**/*.tfvars'
      - '.github/workflows/terraform-ci-cd.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment tfvars (dev/test/prod)"
        type: choice
        required: true
        options: [dev, test, prod]
        default: dev
      auto_approve:
        description: "Apply without manual approval (use with caution)"
        type: boolean
        required: false
        default: false

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
  ARM_USE_OIDC: "true"

jobs:
  plan:
    name: Terraform fmt/validate/plan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJSON( github.event_name == 'pull_request' && '["dev"]' || '["dev","test","prod"]' ) }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - run: terraform fmt -check -recursive
      - run: terraform init
      - run: terraform validate
      - name: Terraform Plan (${{ matrix.environment }})
        run: |
          terraform plan             -var-file="environments/${{ matrix.environment }}.tfvars"             -out="plan-${{ matrix.environment }}.tfplan"             -no-color | tee "plan-${{ matrix.environment }}.txt"
      - uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: |
            plan-${{ matrix.environment }}.tfplan
            plan-${{ matrix.environment }}.txt
      - name: Comment PR with Plan (dev only)
        if: github.event_name == 'pull_request' && matrix.environment == 'dev'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: plan-dev.txt

  apply:
    if: github.event_name == 'workflow_dispatch'
    name: Terraform Apply (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p ${{ env.TF_PLUGIN_CACHE_DIR }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - run: terraform init
      - name: Terraform Plan (to-apply)
        run: |
          terraform plan             -var-file="environments/${{ inputs.environment }}.tfvars"             -out="to-apply.tfplan"             -no-color | tee "plan-to-apply.txt"
      - name: Manual approval gate
        if: ${{ !inputs.auto_approve }}
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ vars.APPROVERS || '' }}
          minimum-approvals: 1
          issue-title: "Approve Terraform Apply to ${{ inputs.environment }}"
          issue-body: "Review the plan in artifacts and approve to proceed."
      - run: terraform apply -auto-approve "to-apply.tfplan"
      - run: terraform output -json > tf-outputs.json
      - uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment }}
          path: tf-outputs.json
